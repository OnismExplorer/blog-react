name: "ğŸ“¬ Notify Author on New Comment (æ–°å›å¤æ—¶é€šçŸ¥ä½œè€…)"

on:
  issue_comment:
    types: [created]

jobs:
  notify-author:
    # ä»…å½“è¯„è®ºè€…ä¸æ˜¯æœºå™¨äººï¼Œä¹Ÿä¸æ˜¯ Issue åˆ›å»ºè€…æ—¶æ‰è¿è¡Œ (Only run if the commenter is not a bot and not the issue author)
    if: github.event.sender.type != 'Bot' && github.event.comment.user.login != github.event.issue.user.login
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ” Extract author's email from issue body (ä»Issueå†…å®¹ä¸­æå–ä½œè€…é‚®ç®±)"
        id: get_email
        # è¿™é‡Œçš„æ­£åˆ™è¡¨è¾¾å¼éœ€è¦ä¸ä½ çš„ issue æ¨¡æ¿ä¸­â€œè”ç³»é‚®ç®±â€çš„æ ‡é¢˜å®Œå…¨åŒ¹é…
        # The regex here needs to exactly match the title of "Contact Email" in your issue template
        run: |
          email=$(echo "${{ github.event.issue.body }}" | grep -oP '### è”ç³»é‚®ç®± \(Contact Email for Notifications\)\s*\n\s*\K[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}')
          echo "email=$email" >> $GITHUB_OUTPUT

      - name: "âœ‰ï¸ Send notification email to author (å‘é€é€šçŸ¥é‚®ä»¶ç»™ä½œè€…)"
        # ä»…å½“æˆåŠŸæå–åˆ°é‚®ç®±æ—¶æ‰æ‰§è¡Œæ­¤æ­¥éª¤ (Only run if an email was successfully extracted)
        if: steps.get_email.outputs.email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}

          subject: "ã€æ–°å›å¤/New Replyã€‘ä½ åœ¨é¡¹ç›®ä¸­çš„ Issue æœ‰äº†æ–°å›å¤ / Your issue in the project has a new reply"

          to: ${{ steps.get_email.outputs.email }}

          from: Blog React Notifier <${{ secrets.MAIL_USERNAME }}>

          html_body: |
            <p>ä½ å¥½ (Hello), <b>${{ github.event.issue.user.login }}</b>!</p>
            <p>ä½ åœ¨é¡¹ç›®ä¸­æäº¤çš„ Issue æ”¶åˆ°äº†æ¥è‡ª <b>${{ github.event.comment.user.login }}</b> çš„æ–°å›å¤ã€‚</p>
            <p>Your issue submitted in the project has received a new reply from <b>${{ github.event.comment.user.login }}</b>.</p>
            <hr>
            <p><b>ä½ çš„ Issue æ ‡é¢˜ (Your Issue Title):</b></p>
            <p>${{ github.event.issue.title }}</p>
            <p><b>å›å¤å†…å®¹ (Reply Content):</b></p>
            <pre>${{ github.event.comment.body }}</pre>
            <hr>
            <p>ä½ å¯ä»¥ç‚¹å‡»ä¸‹é¢çš„é“¾æ¥æŸ¥çœ‹å®Œæ•´çš„è®¨è®ºï¼š</p>
            <p>You can view the full discussion by clicking the link below:</p>
            <p><a href="${{ github.event.comment.html_url }}">${{ github.event.comment.html_url }}</a></p>
