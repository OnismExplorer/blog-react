name: "ğŸ“¬ Notify Author on New Comment (æ–°å›å¤æ—¶é€šçŸ¥ä½œè€…)"

on:
  issue_comment:
    types: [created]

jobs:
  notify-author:
    # ä»…å½“è¯„è®ºè€…ä¸æ˜¯æœºå™¨äººï¼Œä¹Ÿä¸æ˜¯ Issue åˆ›å»ºè€…æ—¶æ‰è¿è¡Œ (Only run if the commenter is not a bot and not the issue author)
    if: github.event.sender.type != 'Bot' && github.event.comment.user.login != github.event.issue.user.login
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ” Extract author's email from issue body (ä»Issueå†…å®¹ä¸­æå–ä½œè€…é‚®ç®±)"
        id: get_email
        # è¿™é‡Œçš„æ­£åˆ™è¡¨è¾¾å¼éœ€è¦ä¸ä½ çš„ issue æ¨¡æ¿ä¸­â€œè”ç³»é‚®ç®±â€çš„æ ‡é¢˜å®Œå…¨åŒ¹é…
        # The regex here needs to exactly match the title of "Contact Email" in your issue template
        run: |
          email=$(echo "${{ github.event.issue.body }}" | grep -oP '### è”ç³»é‚®ç®± \(Contact Email for Notifications\)[[:space:]]*\K[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}')
          echo "email=$email" >> $GITHUB_OUTPUT

      - name: "ğŸ”„ Convert comment markdown to HTML (å°†è¯„è®ºä» md æ ¼å¼è½¬æ¢ä¸º html æ ¼å¼)"
        if: steps.get_email.outputs.email
        id: md_to_html
        uses: c-hive/md-to-html@v1
        with:
          markdown: ${{ github.event.comment.body }}

      - name: "âœ‰ï¸ Send notification email to author (å‘é€é€šçŸ¥é‚®ä»¶ç»™ä½œè€…)"
        # ä»…å½“æˆåŠŸæå–åˆ°é‚®ç®±æ—¶æ‰æ‰§è¡Œæ­¤æ­¥éª¤ (Only run if an email was successfully extracted)
        if: steps.get_email.outputs.email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}

          subject: "ã€æ–°å›å¤/New Replyã€‘ä½ åœ¨ ${{ github.repository }} é¡¹ç›®ä¸­çš„ Issue æœ‰äº†æ–°å›å¤ / Your issue in the project has a new reply"

          to: ${{ steps.get_email.outputs.email }}

          from: "${{ github.repository_owner }} - ${{ github.event.repository.name }} Notifier <${{ secrets.MAIL_USERNAME }}>"

          html_body: |
            <!DOCTYPE html>
            <html lang="en">
            <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>New Reply Notification</title>
            </head>
            <body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji'; background-color: #f6f8fa;">
              <table width="100%" border="0" cellpadding="0" cellspacing="0">
                <tr>
                  <td align="center" style="padding: 20px 0;">
                    <table width="600" border="0" cellpadding="0" cellspacing="0" style="max-width: 600px; border: 1px solid #e1e4e8; border-radius: 6px; background-color: #ffffff;">
                      <!-- Header -->
                      <tr>
                        <td align="center" style="padding: 24px; border-bottom: 1px solid #e1e4e8; background-color: #0366d6;">
                          <h1 style="color: #ffffff; margin: 0; font-size: 24px; font-weight: 600;">æ–°å›å¤é€šçŸ¥ (New Reply)</h1>
                        </td>
                      </tr>
                      <!-- Content -->
                      <tr>
                        <td style="padding: 24px;">
                          <p style="margin: 0 0 16px; font-size: 16px; line-height: 1.5;">ä½ å¥½ (Hello), <b>${{ github.event.issue.user.login }}</b>!</p>

                          <p style="margin: 0 0 24px; font-size: 16px; line-height: 1.5;">
                            ä½ åœ¨ <b>${{ github.repository }}</b> é¡¹ç›®ä¸­æäº¤çš„ Issue æ”¶åˆ°äº†æ¥è‡ª <b>${{ github.event.comment.user.login }}</b> çš„æ–°å›å¤ã€‚
                            <br>
                            Your issue in the <b>${{ github.repository }}</b> project has received a new reply from <b>${{ github.event.comment.user.login }}</b>.
                          </p>
            
                          <!-- Issue Title -->
                          <div style="padding: 16px; border: 1px solid #e1e4e8; border-radius: 6px; background-color: #f6f8fa; margin-bottom: 24px;">
                            <p style="margin: 0; color: #586069; font-size: 14px;">ä½ çš„ Issue æ ‡é¢˜ (Your Issue Title):</p>
                            <h3 style="margin: 4px 0 0; font-size: 18px; font-weight: 600;">${{ github.event.issue.title }}</h3>
                          </div>
            
                          <!-- New Comment Body -->
                          <div style="margin-bottom: 24px;">
                            <p style="margin: 0 0 12px; color: #586069; font-size: 14px; font-weight: bold;">å›å¤å†…å®¹ (Reply Content):</p>
                            <div style="padding: 16px; border-left: 4px solid #0366d6; background-color: #f6f8fa; font-size: 16px; line-height: 1.6;">
                              ${{ steps.md_to_html.outputs.html }}
                            </div>
                          </div>
            
                          <!-- Call to Action Button -->
                          <table width="100%" border="0" cellspacing="0" cellpadding="0">
                            <tr>
                              <td align="center">
                                <a href="${{ github.event.comment.html_url }}"
                                  style="display: inline-block; padding: 12px 24px; font-size: 16px; font-weight: 600; color: #ffffff; text-decoration: none; background-color: #2ea44f; border-radius: 6px;">
                                  æŸ¥çœ‹å®Œæ•´è®¨è®º (View Full Discussion)
                                </a>
                              </td>
                            </tr>
                          </table>
                        </td>
                      </tr>
                      <!-- Footer -->
                      <tr>
                        <td align="center" style="padding: 16px; border-top: 1px solid #e1e4e8; color: #959da5; font-size: 12px;">
                          è¿™æ˜¯ä¸€å°æ¥è‡ª <b>${{ github.repository }}</b> é¡¹ç›®çš„è‡ªåŠ¨é€šçŸ¥é‚®ä»¶ã€‚
                          <br>
                          This is an automated notification from the <b>${{ github.repository }}</b> project.
                        </td>
                      </tr>
                    </table>
                  </td>
                </tr>
              </table>
            </body>
            </html>
